<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TraxFlow - Плеер</title>
  <style>
    :root {
      --primary-color: #6e8efb;
      --primary-hover: #5a7df3;
      --text-color: #333;
      --text-secondary: #666;
      --bg-color: #f5f5f5;
      --card-bg: white;
      --border-color: #eee;
      --highlight-bg: #eef4ff;
      --error-color: #ff5722;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    body {
      background-color: var(--bg-color);
      color: var(--text-color);
      line-height: 1.6;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    .player-container {
      width: 100%;
      max-width: 800px;
      background: var(--card-bg);
      border-radius: 10px;
      padding: 25px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .tracks-list {
      margin-top: 25px;
      max-height: 400px;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: var(--primary-color) #f1f1f1;
    }

    .tracks-list::-webkit-scrollbar {
      width: 8px;
    }

    .tracks-list::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }

    .tracks-list::-webkit-scrollbar-thumb {
      background-color: var(--primary-color);
      border-radius: 4px;
    }
    
    .track-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 15px;
      border-bottom: 1px solid var(--border-color);
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .track-item:hover {
      background: rgba(0,0,0,0.03);
    }
    
    .track-item.now-playing {
      background: var(--highlight-bg);
      border-left: 4px solid var(--primary-color);
    }
    
    .track-info {
      flex-grow: 1;
      min-width: 0;
    }
    
    .track-title {
      font-weight: 600;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .track-artist {
      color: var(--text-secondary);
      font-size: 0.9rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .track-duration {
      color: var(--text-secondary);
      margin-left: 15px;
      white-space: nowrap;
      font-size: 0.9rem;
    }
    
    .player-controls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      margin: 30px 0;
    }
    
    .player-controls button {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      border: none;
      background: var(--primary-color);
      color: white;
      cursor: pointer;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      outline: none;
    }
    
    .player-controls button:hover {
      background: var(--primary-hover);
      transform: scale(1.05);
    }

    #play-btn {
      width: 60px;
      height: 60px;
      font-size: 1.4rem;
    }
    
    .now-playing-info {
      text-align: center;
      margin: 20px 0;
      padding: 0 10px;
    }
    
    .now-playing-title {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 5px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .now-playing-artist {
      color: var(--text-secondary);
      font-size: 1.1rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .progress-container {
      margin: 30px 0;
    }
    
    .progress-bar {
      height: 6px;
      background: #e0e0e0;
      border-radius: 3px;
      cursor: pointer;
      overflow: hidden;
      transition: height 0.2s;
    }

    .progress-bar:hover {
      height: 8px;
    }
    
    .progress {
      height: 100%;
      background: var(--primary-color);
      width: 0%;
      border-radius: 3px;
      transition: width 0.1s;
    }
    
    .time-info {
      display: flex;
      justify-content: space-between;
      margin-top: 8px;
      color: var(--text-secondary);
      font-size: 0.85rem;
    }
    
    .status-message {
      text-align: center;
      padding: 30px 20px;
      font-size: 1.1rem;
    }
    
    .loading-message {
      color: var(--text-secondary);
    }
    
    .error-message {
      color: var(--error-color);
    }
    
    .empty-message {
      color: var(--text-secondary);
    }
    
    .retry-button {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      margin-top: 15px;
      cursor: pointer;
      font-size: 1rem;
      transition: background 0.2s;
    }
    
    .retry-button:hover {
      background: var(--primary-hover);
    }

    @media (max-width: 600px) {
      .player-container {
        padding: 15px;
      }

      .now-playing-title {
        font-size: 1.3rem;
      }

      .now-playing-artist {
        font-size: 1rem;
      }

      .player-controls {
        gap: 15px;
      }

      .player-controls button {
        width: 45px;
        height: 45px;
      }

      #play-btn {
        width: 55px;
        height: 55px;
      }
    }
  </style>
</head>
<body>
  <div class="player-container">
    <div class="now-playing-info">
      <div class="now-playing-title" id="now-playing-title">Выберите трек</div>
      <div class="now-playing-artist" id="now-playing-artist"></div>
    </div>
    
    <div class="progress-container">
      <div class="progress-bar" id="progress-container">
        <div class="progress" id="progress-bar"></div>
      </div>
      <div class="time-info">
        <span id="current-time">0:00</span>
        <span id="duration">0:00</span>
      </div>
    </div>
    
    <div class="player-controls">
      <button id="prev-btn" aria-label="Предыдущий трек">⏮</button>
      <button id="play-btn" aria-label="Воспроизвести">▶</button>
      <button id="next-btn" aria-label="Следующий трек">⏭</button>
    </div>
    
    <div class="tracks-list" id="tracks-container">
      <div class="status-message loading-message">Загрузка треков...</div>
    </div>
    
    <audio id="audio-player"></audio>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      class MusicPlayer {
        constructor() {
          this.playlist = [];
          this.currentIndex = 0;
          this.isPlaying = false;
          this.audio = document.getElementById('audio-player');
          this.initElements();
          this.initEventListeners();
          this.loadTracks();
        }

        initElements() {
          this.elements = {
            playBtn: document.getElementById('play-btn'),
            prevBtn: document.getElementById('prev-btn'),
            nextBtn: document.getElementById('next-btn'),
            progressBar: document.getElementById('progress-bar'),
            progressContainer: document.getElementById('progress-container'),
            currentTime: document.getElementById('current-time'),
            duration: document.getElementById('duration'),
            nowPlayingTitle: document.getElementById('now-playing-title'),
            nowPlayingArtist: document.getElementById('now-playing-artist'),
            tracksContainer: document.getElementById('tracks-container')
          };
        }

        initEventListeners() {
          this.audio.addEventListener('timeupdate', this.updateProgress.bind(this));
          this.audio.addEventListener('ended', this.nextTrack.bind(this));
          this.audio.addEventListener('loadedmetadata', this.updateDuration.bind(this));
          
          this.elements.playBtn.addEventListener('click', this.togglePlay.bind(this));
          this.elements.prevBtn.addEventListener('click', this.prevTrack.bind(this));
          this.elements.nextBtn.addEventListener('click', this.nextTrack.bind(this));
          
          this.elements.progressContainer.addEventListener('click', (e) => {
            if (!this.audio.src) return;
            const rect = e.target.getBoundingClientRect();
            const percent = (e.clientX - rect.left) / rect.width;
            this.audio.currentTime = percent * this.audio.duration;
          });
        }

        async loadTracks() {
          try {
            this.showStatusMessage('Загрузка треков...', 'loading');
            
            const response = await fetch('/api/tracks');
            if (!response.ok) throw new Error('Ошибка загрузки треков');
            
            const data = await response.json();
            this.playlist = data.tracks || [];
            
            if (this.playlist.length === 0) {
              this.showStatusMessage('Нет доступных треков. Загрузите треки через форму загрузки.', 'empty');
            } else {
              this.renderTracks();
              this.restoreState();
            }
          } catch (error) {
            console.error('Ошибка загрузки треков:', error);
            this.showStatusMessage(
              'Не удалось загрузить треки. Пожалуйста, попробуйте позже.',
              'error',
              true
            );
          }
        }

        showStatusMessage(message, type, showRetry = false) {
          this.elements.tracksContainer.innerHTML = `
            <div class="status-message ${type}-message">
              ${message}
              ${showRetry ? '<button class="retry-button" id="retry-button">Попробовать снова</button>' : ''}
            </div>
          `;
          
          if (showRetry) {
            document.getElementById('retry-button').addEventListener('click', () => {
              this.loadTracks();
            });
          }
        }

        renderTracks() {
          this.elements.tracksContainer.innerHTML = this.playlist.map((track, index) => `
            <div class="track-item ${index === this.currentIndex && this.isPlaying ? 'now-playing' : ''}" 
                 data-index="${index}">
              <div class="track-info">
                <div class="track-title">${track.title || 'Без названия'}</div>
                <div class="track-artist">${track.artist || 'Неизвестен'}</div>
              </div>
              <div class="track-duration">${this.formatTime(track.duration || 0)}</div>
            </div>
          `).join('');
          
          document.querySelectorAll('.track-item').forEach(item => {
            item.addEventListener('click', () => {
              this.playTrack(parseInt(item.dataset.index));
            });
          });
        }

        playTrack(index) {
          if (index < 0 || index >= this.playlist.length) return;
          
          this.currentIndex = index;
          const track = this.playlist[this.currentIndex];
          
          if (!track?.streamUrl) {
            console.error('Некорректные данные трека:', track);
            return;
          }
          
          this.audio.src = track.streamUrl;
          this.updateTrackInfo(track);
          this.updateTrackListHighlight();
          
          this.audio.play()
            .then(() => {
              this.isPlaying = true;
              this.elements.playBtn.textContent = '⏸';
              this.saveState();
            })
            .catch(error => {
              console.error('Ошибка воспроизведения:', error);
              this.showStatusMessage('Не удалось воспроизвести трек', 'error');
            });
        }

        updateTrackInfo(track) {
          this.elements.nowPlayingTitle.textContent = track.title || 'Без названия';
          this.elements.nowPlayingArtist.textContent = track.artist || 'Неизвестен';
        }

        updateTrackListHighlight() {
          document.querySelectorAll('.track-item').forEach((item, i) => {
            item.classList.toggle('now-playing', i === this.currentIndex && this.isPlaying);
          });
        }

        togglePlay() {
          if (this.playlist.length === 0) return;
          
          if (this.audio.paused) {
            if (!this.audio.src) {
              this.playTrack(0);
            } else {
              this.audio.play()
                .then(() => {
                  this.isPlaying = true;
                  this.elements.playBtn.textContent = '⏸';
                  this.saveState();
                })
                .catch(error => {
                  console.error('Ошибка воспроизведения:', error);
                });
            }
          } else {
            this.audio.pause();
            this.isPlaying = false;
            this.elements.playBtn.textContent = '▶';
            this.saveState();
          }
        }

        nextTrack() {
          if (this.playlist.length === 0) return;
          this.playTrack((this.currentIndex + 1) % this.playlist.length);
        }

        prevTrack() {
          if (this.playlist.length === 0) return;
          this.playTrack((this.currentIndex - 1 + this.playlist.length) % this.playlist.length);
        }

        updateProgress() {
          const progress = (this.audio.currentTime / this.audio.duration) * 100 || 0;
          this.elements.progressBar.style.width = `${progress}%`;
          this.elements.currentTime.textContent = this.formatTime(this.audio.currentTime);
        }

        updateDuration() {
          this.elements.duration.textContent = this.formatTime(this.audio.duration);
        }

        formatTime(seconds) {
          if (isNaN(seconds)) return '0:00';
          const minutes = Math.floor(seconds / 60);
          const secs = Math.floor(seconds % 60);
          return `${minutes}:${secs.toString().padStart(2, '0')}`;
        }

        restoreState() {
          try {
            const savedState = localStorage.getItem('playerState');
            if (savedState) {
              const state = JSON.parse(savedState);
              this.currentIndex = state.index || 0;
              this.isPlaying = state.playing || false;
              
              if (this.isPlaying && this.playlist.length > 0) {
                this.playTrack(this.currentIndex);
              }
            }
          } catch (e) {
            console.error('Ошибка восстановления состояния:', e);
          }
        }

        saveState() {
          localStorage.setItem('playerState', JSON.stringify({
            index: this.currentIndex,
            playing: this.isPlaying
          }));
        }
      }

      // Инициализация плеера
      new MusicPlayer();
    });
  </script>
</body>
</html>